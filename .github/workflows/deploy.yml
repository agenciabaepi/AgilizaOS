name: Deploy to VPS (PM2)
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS with PM2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸš€ Iniciando deploy automÃ¡tico com PM2..."
            
            # Verificar se PM2 estÃ¡ instalado
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Instalando PM2..."
              npm install -g pm2
            fi
            
            # Verificar diretÃ³rio
            if [ ! -d "/opt/gestaoconsert" ]; then
              echo "ğŸ”§ Criando diretÃ³rio..."
              sudo mkdir -p /opt/gestaoconsert
              sudo chown $USER:$USER /opt/gestaoconsert
            fi
            
            cd /opt/gestaoconsert
            
            # Baixar cÃ³digo
            echo "ğŸ“¥ Baixando cÃ³digo..."
            git pull origin main || git clone https://github.com/agenciabaepi/AgilizaOS.git .
            
            # Instalar dependÃªncias
            echo "ğŸ”§ Instalando dependÃªncias..."
            yarn install --frozen-lockfile
            
            # Build
            echo "ğŸ—ï¸ Fazendo build..."
            yarn build
            
            # Parar aplicaÃ§Ã£o anterior
            echo "â¹ï¸ Parando aplicaÃ§Ã£o anterior..."
            pm2 stop gestaoconsert || echo "AplicaÃ§Ã£o nÃ£o estava rodando"
            pm2 delete gestaoconsert || echo "AplicaÃ§Ã£o nÃ£o existia"
            
            # Iniciar nova aplicaÃ§Ã£o
            echo "â–¶ï¸ Iniciando nova aplicaÃ§Ã£o..."
            pm2 start yarn --name "gestaoconsert" -- start
            pm2 save
            pm2 startup
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ AplicaÃ§Ã£o rodando na porta 3000"
